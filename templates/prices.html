{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-0 px-lg-3">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="h4 mb-0">
        <i class="bi bi-graph-up-arrow text-success"></i> Live Crypto Prices
        <span class="badge bg-info ms-2" id="price-count">{{ data.prices|length }} pairs</span>
        <span class="badge bg-success ms-1" style="font-size: 0.6em;">
            <i class="bi bi-broadcast"></i> LIVE
        </span>
    </h2>
    <div class="d-flex gap-2">
        <!-- View Toggle -->
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-light active" id="view-grid" onclick="toggleView('grid')">
                <i class="bi bi-grid"></i> Grid
            </button>
            <button class="btn btn-sm btn-outline-light" id="view-table" onclick="toggleView('table')">
                <i class="bi bi-table"></i> Table
            </button>
        </div>
        <!-- Sort Dropdown -->
        <select class="form-select form-select-sm" id="sort-select" onchange="sortPrices()" style="width: auto;">
            <option value="symbol">Sort: Symbol A-Z</option>
            <option value="price-desc">Price: High-Low</option>
            <option value="price-asc">Price: Low-High</option>
            <option value="change-desc">Change: High-Low</option>
            <option value="change-asc">Change: Low-High</option>
            <option value="volume-desc">Volume: High-Low</option>
        </select>
        <button class="btn btn-sm btn-outline-light" onclick="refreshPrices()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>
    
    {% if not data.prices %}
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3 text-muted">Fetching live prices...</p>
        </div>
    </div>
    {% else %}
    
    <!-- Price Cards Grid -->
    <div class="row g-2" id="prices-grid">
        {% for price in data.prices %}
        {% set symbol_base = price.symbol.split('/')[0] %}
        <div class="col-6 col-md-4 col-lg-3 col-xl-2">
            <div class="card h-100 {{ 'border-success' if price.change_24h|default(0) > 0 else 'border-danger' if price.change_24h|default(0) < 0 else '' }}">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <!-- Crypto Icon -->
                            <img src="" 
                                 data-symbol="{{ symbol_base }}"
                                 class="coin-icon me-2" 
                                 style="width: 32px; height: 32px; border-radius: 50%; background: #1a1a2e;"
                                 alt="{{ symbol_base }}">
                            <div>
                                <div class="fw-bold">{{ symbol_base }}</div>
                                <small class="text-muted">{{ price.exchange }}</small>
                            </div>
                        </div>
                        {% if price.change_24h|default(0) != 0 %}
                        <span class="badge {{ 'bg-success' if price.change_24h > 0 else 'bg-danger' }}">
                            {{ "%.1f"|format(price.change_24h) }}%
                        </span>
                        {% endif %}
                    </div>
                    <div class="h4 mb-1">${{ "%.2f"|format(price.price) }}</div>
                    <div class="d-flex justify-content-between text-muted small">
                        <span>B: ${{ "%.2f"|format(price.bid|default(price.price)) }}</span>
                        <span>A: ${{ "%.2f"|format(price.ask|default(price.price)) }}</span>
                    </div>
                    <!-- Chart Button -->
                    <button class="btn btn-sm btn-outline-info w-100 mt-2" onclick="showChart('{{ symbol_base }}')">
                        <i class="bi bi-graph-up"></i> Chart
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Detailed Table -->
    <div class="card mt-3" id="prices-table-container">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-table"></i> Detailed View</span>
            <div>
                <button class="btn btn-sm btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#discoveryModal">
                    <i class="bi bi-search"></i> Discover Coins
                </button>
                <button class="btn btn-sm btn-outline-light" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-wrapper">
                <table class="table table-dark table-hover table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Coin</th>
                            <th>Exchange</th>
                            <th>Price</th>
                            <th>24h Change</th>
                            <th>Bid/Ask Spread</th>
                            <th>Volume 24h</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for price in data.prices %}
                        {% set symbol_base = price.symbol.split('/')[0] %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="" 
                                         data-symbol="{{ symbol_base }}"
                                         class="coin-icon me-2" 
                                         style="width: 24px; height: 24px; border-radius: 50%; background: #1a1a2e;"
                                         alt="{{ symbol_base }}">
                                    <span class="fw-bold">{{ symbol_base }}</span>
                                </div>
                            </td>
                            <td>{{ price.exchange }}</td>
                            <td class="fw-bold">${{ "%.2f"|format(price.price) }}</td>
                            <td>
                                {% if price.change_24h|default(0) > 0 %}
                                <span class="text-success">+{{ "%.2f"|format(price.change_24h) }}%</span>
                                {% elif price.change_24h|default(0) < 0 %}
                                <span class="text-danger">{{ "%.2f"|format(price.change_24h) }}%</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set spread = ((price.ask|default(price.price) - price.bid|default(price.price)) / price.price * 100) %}
                                <span class="{{ 'text-success' if spread < 0.1 else 'text-warning' if spread < 0.5 else 'text-danger' }}">
                                    {{ "%.3f"|format(spread) }}%
                                </span>
                            </td>
                            <td>{{ "{:,.0f}".format(price.volume_24h|default(0)) }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="showChart('{{ symbol_base }}')">
                                    <i class="bi bi-graph-up"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Chart Modal -->
<div class="modal fade" id="chartModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center">
                    <img id="chart-coin-icon" src="" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background: #1a1a2e;">
                    <span id="chart-coin-name">Chart</span>
                    <span class="badge bg-success ms-3" style="font-size: 0.6em;">
                        <i class="bi bi-broadcast"></i> LIVE
                    </span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Timeframe Buttons -->
                <div class="btn-group mb-3 w-100" role="group">
                    <button type="button" class="btn btn-outline-light tf-btn" data-tf="1">24H</button>
                    <button type="button" class="btn btn-outline-light tf-btn" data-tf="7">7D</button>
                    <button type="button" class="btn btn-outline-light tf-btn active" data-tf="30">30D</button>
                    <button type="button" class="btn btn-outline-light tf-btn" data-tf="90">90D</button>
                    <button type="button" class="btn btn-outline-light tf-btn" data-tf="365">1Y</button>
                    <button type="button" class="btn btn-outline-light tf-btn" data-tf="max">ALL</button>
                </div>
                
                <!-- Chart Container -->
                <div id="chart-container" style="height: 400px; background: #0a0e14; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-2"></div>
                        <p class="text-muted">Loading chart...</p>
                    </div>
                </div>
                
                <!-- Stats Row -->
                <div class="row mt-3" id="chart-stats">
                    <div class="col-3 text-center">
                        <small class="text-muted">High</small>
                        <div class="h5 text-success" id="stat-high">-</div>
                    </div>
                    <div class="col-3 text-center">
                        <small class="text-muted">Low</small>
                        <div class="h5 text-danger" id="stat-low">-</div>
                    </div>
                    <div class="col-3 text-center">
                        <small class="text-muted">Avg Vol</small>
                        <div class="h5" id="stat-volume">-</div>
                    </div>
                    <div class="col-3 text-center">
                        <small class="text-muted">Change</small>
                        <div class="h5" id="stat-change">-</div>
                    </div>
                </div>
                
                <!-- Data Source Footer -->
                <div class="mt-3 pt-2 border-top border-secondary text-center">
                    <small class="text-muted">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Data from <strong>CoinGecko API</strong> â€¢ 
                        <span id="data-points-count">-</span> price points â€¢ 
                        Updated <span id="last-updated">just now</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Coin Discovery Modal -->
<div class="modal fade" id="discoveryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-search"></i> Coin Discovery</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="discoveryTabs">
                    <li class="nav-item">
                        <button class="nav-link active" id="trending-tab" data-bs-toggle="tab" data-bs-target="#trending">ðŸ”¥ Trending</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="gainers-tab" data-bs-toggle="tab" data-bs-target="#gainers">ðŸ“ˆ Gainers</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="potential-tab" data-bs-toggle="tab" data-bs-target="#potential">ðŸ’Ž Potential</button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="trending">
                        <div id="trending-loading" class="text-center py-4">
                            <div class="spinner-border"></div>
                        </div>
                        <div id="trending-content"></div>
                    </div>
                    <div class="tab-pane fade" id="gainers">
                        <div id="gainers-loading" class="text-center py-4">
                            <div class="spinner-border"></div>
                        </div>
                        <div id="gainers-content"></div>
                    </div>
                    <div class="tab-pane fade" id="potential">
                        <div id="potential-loading" class="text-center py-4">
                            <div class="spinner-border"></div>
                        </div>
                        <div id="potential-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="/static/js/coinData.js"></script>
<script>
let currentChart = null;
let currentSymbol = '';
let currentTimeframe = '30';

// Set up icons on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCoinIcons();
});

function loadCoinIcons() {
    document.querySelectorAll('.coin-icon').forEach(img => {
        const symbol = img.getAttribute('data-symbol');
        if (symbol) {
            img.src = getCoinIconUrl(symbol);
            img.onerror = function() {
                // Final fallback
                this.src = `https://ui-avatars.com/api/?name=${symbol}&background=random&color=fff&size=64&bold=true`;
            };
        }
    });
}

function refreshPrices() {
    location.reload();
}

// Toggle between grid and table views
function toggleView(view) {
    const grid = document.getElementById('prices-grid');
    const table = document.getElementById('prices-table-container');
    const gridBtn = document.getElementById('view-grid');
    const tableBtn = document.getElementById('view-table');
    
    if (view === 'grid') {
        grid.style.display = '';
        if (table) table.style.display = 'none';
        gridBtn.classList.add('active');
        tableBtn.classList.remove('active');
        localStorage.setItem('prices-view', 'grid');
    } else {
        grid.style.display = 'none';
        if (table) table.style.display = '';
        gridBtn.classList.remove('active');
        tableBtn.classList.add('active');
        localStorage.setItem('prices-view', 'table');
    }
}

// Sort prices
function sortPrices() {
    const sortValue = document.getElementById('sort-select').value;
    const grid = document.getElementById('prices-grid');
    const cards = Array.from(grid.children);
    
    cards.sort((a, b) => {
        const getValue = (card, type) => {
            if (type === 'symbol') {
                return card.querySelector('.fw-bold').textContent;
            }
            if (type === 'price') {
                const priceText = card.querySelector('.h4').textContent.replace('$', '').replace(',', '');
                return parseFloat(priceText);
            }
            if (type === 'change') {
                const badge = card.querySelector('.badge.bg-success, .badge.bg-danger');
                if (!badge) return 0;
                return parseFloat(badge.textContent);
            }
            return 0;
        };
        
        let valA, valB;
        
        switch(sortValue) {
            case 'symbol':
                valA = getValue(a, 'symbol');
                valB = getValue(b, 'symbol');
                return valA.localeCompare(valB);
            case 'price-desc':
                valA = getValue(a, 'price');
                valB = getValue(b, 'price');
                return valB - valA;
            case 'price-asc':
                valA = getValue(a, 'price');
                valB = getValue(b, 'price');
                return valA - valB;
            case 'change-desc':
                valA = getValue(a, 'change');
                valB = getValue(b, 'change');
                return valB - valA;
            case 'change-asc':
                valA = getValue(a, 'change');
                valB = getValue(b, 'change');
                return valA - valB;
            default:
                return 0;
        }
    });
    
    // Re-append in sorted order
    cards.forEach(card => grid.appendChild(card));
}

// Initialize view preference
document.addEventListener('DOMContentLoaded', () => {
    const savedView = localStorage.getItem('prices-view') || 'grid';
    if (savedView === 'table') {
        toggleView('table');
    }
});

function showChart(symbol) {
    currentSymbol = symbol;
    currentTimeframe = '30';
    
    // Set icon and name
    document.getElementById('chart-coin-icon').src = getCoinIconUrl(symbol);
    document.getElementById('chart-coin-name').textContent = `${symbol}/USDT Price Chart`;
    
    // Reset timeframe buttons
    document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-tf="30"]').classList.add('active');
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('chartModal'));
    modal.show();
    
    // Load chart
    loadChart(symbol, currentTimeframe);
}

// Timeframe button handlers
document.querySelectorAll('.tf-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTimeframe = this.getAttribute('data-tf');
        loadChart(currentSymbol, currentTimeframe);
    });
});

async function loadChart(symbol, timeframe) {
    const container = document.getElementById('chart-container');
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary mb-2"></div><p class="text-muted">Loading chart...</p></div>';
    
    try {
        const coinId = getCoinGeckoId(symbol);
        
        // Fetch historical data from CoinGecko
        const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${timeframe}`);
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.prices || data.prices.length === 0) {
            throw new Error('No price data available');
        }
        
        const prices = data.prices.map(p => ({ x: p[0], y: p[1] }));
        
        // Calculate stats
        const prices_only = prices.map(p => p.y);
        const high = Math.max(...prices_only);
        const low = Math.min(...prices_only);
        const avgVolume = data.total_volumes.reduce((a, b) => a + b[1], 0) / data.total_volumes.length;
        const change = ((prices_only[prices_only.length - 1] - prices_only[0]) / prices_only[0] * 100);
        
        document.getElementById('stat-high').textContent = '$' + high.toLocaleString(undefined, {maximumFractionDigits: 2});
        document.getElementById('stat-low').textContent = '$' + low.toLocaleString(undefined, {maximumFractionDigits: 2});
        document.getElementById('stat-volume').textContent = '$' + (avgVolume / 1e6).toFixed(1) + 'M';
        document.getElementById('stat-change').textContent = (change > 0 ? '+' : '') + change.toFixed(2) + '%';
        document.getElementById('stat-change').className = 'h5 ' + (change >= 0 ? 'text-success' : 'text-danger');
        
        // Update data source info
        document.getElementById('data-points-count').textContent = prices.length.toLocaleString();
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        
        // Render chart
        container.innerHTML = '<canvas id="priceChart"></canvas>';
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        if (currentChart) {
            currentChart.destroy();
        }
        
        // Create gradient fill
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, change >= 0 ? 'rgba(57, 211, 83, 0.25)' : 'rgba(248, 81, 73, 0.25)');
        gradient.addColorStop(1, change >= 0 ? 'rgba(57, 211, 83, 0.02)' : 'rgba(248, 81, 73, 0.02)');
        
        // Data source indicator
        const sourceNote = document.createElement('div');
        sourceNote.className = 'text-muted small mt-2';
        sourceNote.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> Live data from CoinGecko API â€¢ ' + prices.length + ' data points';
        container.parentNode.insertBefore(sourceNote, container.nextSibling);
        
        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: symbol + ' Price',
                    data: prices,
                    borderColor: change >= 0 ? '#39d353' : '#f85149',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    stepped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: change >= 0 ? '#39d353' : '#f85149',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return '$' + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 4});
                            },
                            title: function(context) {
                                const date = new Date(context[0].parsed.x);
                                return date.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'MMM dd',
                                month: 'MMM yyyy'
                            }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#8b949e', maxTicksLimit: 8 }
                    },
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { 
                            color: '#8b949e',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('Chart error:', error);
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                <p class="mt-3">Chart data unavailable for ${symbol}</p>
                <small class="text-muted">${error.message}</small>
                <br><br>
                <button class="btn btn-sm btn-outline-light" onclick="loadChart('${symbol}', '${timeframe}')">
                    <i class="bi bi-arrow-clockwise"></i> Retry
                </button>
            </div>
        `;
    }
}

// Load discovery data when modal opens
document.getElementById('discoveryModal').addEventListener('show.bs.modal', function () {
    loadDiscoveryData();
});

async function loadDiscoveryData() {
    try {
        const response = await fetch('/api/discovery/coins');
        const data = await response.json();
        
        renderCoinList('trending', data.trending || []);
        renderCoinList('gainers', data.top_gainers || []);
        renderCoinList('potential', data.high_potential || []);
    } catch (error) {
        console.error('Error loading discovery:', error);
    }
}

function renderCoinList(type, coins) {
    document.getElementById(type + '-loading').style.display = 'none';
    const container = document.getElementById(type + '-content');
    
    if (!coins || coins.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No coins found</div>';
        return;
    }
    
    let html = '<div class="list-group">';
    for (const coin of coins) {
        const changeClass = (coin.price_change_24h || 0) > 0 ? 'text-success' : 'text-danger';
        const changeIcon = (coin.price_change_24h || 0) > 0 ? 'â†‘' : 'â†“';
        
        html += `
            <div class="list-group-item bg-dark d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="${getCoinIconUrl(coin.symbol)}" 
                         class="me-2" style="width: 32px; height: 32px; border-radius: 50%; background: #1a1a2e;"
                         onerror="this.src='https://ui-avatars.com/api/?name=${coin.symbol}&background=random&color=fff&size=32'">
                    <div>
                        <div class="fw-bold">${coin.symbol}</div>
                        <small class="text-muted">${coin.name}</small>
                    </div>
                </div>
                <div class="text-end">
                    <div>$${coin.price_usd.toLocaleString(undefined, {maximumFractionDigits: 4})}</div>
                    <small class="${changeClass}">${changeIcon} ${Math.abs(coin.price_change_24h || 0).toFixed(2)}%</small>
                    <div><small class="text-muted">${coin.reason}</small></div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    container.innerHTML = html;
}
</script>
{% endblock %}

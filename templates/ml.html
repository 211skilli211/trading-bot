{% extends "base.html" %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-cpu text-info"></i> AI & ML Command Center</h4>

<!-- Status Cards Row -->
<div class="row g-3 mb-4">
    <!-- Regime Detector Card -->
    <div class="col-md-3">
        <div class="card bg-dark border-info h-100">
            <div class="card-body text-center">
                <i class="bi bi-globe display-4 text-info"></i>
                <h6 class="mt-2">Market Regime</h6>
                <span id="regime-status" class="badge bg-secondary">Checking...</span>
                <div class="small text-muted mt-2" id="regime-details">--</div>
            </div>
        </div>
    </div>
    
    <!-- Multi-Agent Card -->
    <div class="col-md-3">
        <div class="card bg-dark border-success h-100">
            <div class="card-body text-center">
                <i class="bi bi-people display-4 text-success"></i>
                <h6 class="mt-2">Multi-Agent System</h6>
                <span id="agent-count" class="badge bg-secondary">--</span>
                <div class="small text-muted mt-2" id="agent-details">Loading...</div>
                <button class="btn btn-sm btn-outline-success mt-2" onclick="toggleAgentModal()">
                    <i class="bi bi-gear"></i> Manage
                </button>
            </div>
        </div>
    </div>
    
    <!-- ML Predictor Card -->
    <div class="col-md-3">
        <div class="card bg-dark border-warning h-100">
            <div class="card-body text-center">
                <i class="bi bi-graph-up display-4 text-warning"></i>
                <h6 class="mt-2">ML Predictor</h6>
                <span id="ml-status" class="badge bg-success">Active</span>
                <div class="small text-muted mt-2">sklearn + Technical</div>
                <button class="btn btn-sm btn-outline-warning mt-2" onclick="refreshML()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>
    
    <!-- ZeroClaw AI Card -->
    <div class="col-md-3">
        <div class="card bg-dark border-primary h-100">
            <div class="card-body text-center">
                <i class="bi bi-robot display-4 text-primary"></i>
                <h6 class="mt-2">ZeroClaw AI</h6>
                <span id="zeroclaw-status" class="badge bg-secondary">Checking...</span>
                <div class="small text-muted mt-2" id="zeroclaw-details">--</div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="window.location.href='/zeroclaw'">
                    <i class="bi bi-chat"></i> Chat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Management Panel -->
<div class="card mb-4" id="agent-management">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-people text-success"></i> Agent Control Panel</span>
        <div>
            <button class="btn btn-sm btn-outline-success" onclick="runAgentEvaluation()">
                <i class="bi bi-play"></i> Run Evaluation
            </button>
            <button class="btn btn-sm btn-outline-light ms-2" onclick="refreshAgents()">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-hover table-sm" id="agents-table">
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th>Strategy</th>
                        <th>Status</th>
                        <th>Capital</th>
                        <th>P&L</th>
                        <th>Win Rate</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm"></div> Loading agents...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Strategy Toggles -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-toggle-on text-warning"></i> Strategy Activation
    </div>
    <div class="card-body">
        <div class="row g-3" id="strategy-toggles">
            <!-- Strategy toggles loaded dynamically -->
        </div>
    </div>
</div>

<!-- Combined Signals & Regime Info -->
<div class="row g-3">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-magic"></i> Trading Signals
            </div>
            <div class="card-body" id="signals-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">Loading signals...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-calendar-event"></i> Macro Events
            </div>
            <div class="card-body">
                <div id="macro-status" class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Trading Status:</span>
                        <span id="trading-allowed" class="badge bg-secondary">Checking...</span>
                    </div>
                </div>
                <div id="upcoming-events" class="small">
                    <div class="text-muted">Loading events...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Management Modal -->
<div class="modal fade" id="agentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Agent Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="agent-modal-content">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    loadAllData();
    setInterval(loadAllData, 30000); // Refresh every 30s
});

async function loadAllData() {
    await Promise.all([
        loadRegimeStatus(),
        loadAgentStatus(),
        loadZeroClawStatus(),
        loadStrategyToggles(),
        loadSignals(),
        loadMacroEvents()
    ]);
}

// Load Regime Status
async function loadRegimeStatus() {
    try {
        const resp = await fetch('/api/regime/status');
        const data = await resp.json();
        
        if (data.success) {
            const regime = data.data.regime;
            const config = data.data.config;
            
            const badge = document.getElementById('regime-status');
            badge.textContent = regime;
            badge.className = 'badge ' + (regime === 'RISK_ON' ? 'bg-success' : regime === 'DEFENSIVE' ? 'bg-danger' : 'bg-warning text-dark');
            
            document.getElementById('regime-details').innerHTML = `
                Position: ${(config.max_position_pct * 100).toFixed(1)}% | 
                Stop: ${(config.stop_loss_pct * 100).toFixed(0)}%
            `;
        }
    } catch (e) {
        console.error('Regime load failed:', e);
    }
}

// Load Agent Status
async function loadAgentStatus() {
    try {
        const resp = await fetch('/api/multi-agent/status');
        const data = await resp.json();
        
        if (data.success) {
            const ma = data.data;
            document.getElementById('agent-count').textContent = `${ma.active_agents}/${ma.total_agents} Active`;
            document.getElementById('agent-count').className = 'badge bg-success';
            document.getElementById('agent-details').innerHTML = `P&L: $${ma.total_pnl.toFixed(2)}`;
            
            // Update table
            const tbody = document.querySelector('#agents-table tbody');
            tbody.innerHTML = ma.agents.map(agent => `
                <tr>
                    <td><strong>${agent.name}</strong></td>
                    <td><span class="badge bg-secondary">${agent.strategy_type}</span></td>
                    <td>
                        <span class="badge ${agent.status === 'active' ? 'bg-success' : 'bg-danger'}">
                            ${agent.status}
                        </span>
                    </td>
                    <td>$${agent.capital}</td>
                    <td class="${agent.total_pnl >= 0 ? 'text-success' : 'text-danger'}">
                        ${agent.total_pnl >= 0 ? '+' : ''}$${agent.total_pnl.toFixed(2)}
                    </td>
                    <td>${agent.win_rate.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-sm ${agent.status === 'active' ? 'btn-outline-danger' : 'btn-outline-success'}" 
                                onclick="toggleAgent('${agent.name}', '${agent.status}')">
                            ${agent.status === 'active' ? '<i class="bi bi-pause"></i>' : '<i class="bi bi-play"></i>'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    } catch (e) {
        console.error('Agent load failed:', e);
    }
}

// Toggle Agent
async function toggleAgent(name, currentStatus) {
    // This would need an API endpoint
    alert(`${currentStatus === 'active' ? 'Pausing' : 'Activating'} agent: ${name}`);
}

// Load ZeroClaw Status
async function loadZeroClawStatus() {
    try {
        const resp = await fetch('/api/zeroclaw/status');
        const data = await resp.json();
        
        const badge = document.getElementById('zeroclaw-status');
        if (data.running) {
            badge.textContent = 'Online';
            badge.className = 'badge bg-success';
            document.getElementById('zeroclaw-details').textContent = data.paired ? 'Paired' : 'Unpaired';
        } else {
            badge.textContent = 'Offline';
            badge.className = 'badge bg-danger';
            document.getElementById('zeroclaw-details').textContent = 'Start ZeroClaw daemon';
        }
    } catch (e) {
        document.getElementById('zeroclaw-status').textContent = 'Error';
        document.getElementById('zeroclaw-status').className = 'badge bg-warning';
    }
}

// Load Strategy Toggles
async function loadStrategyToggles() {
    const strategies = [
        {id: 'binary_arbitrage', name: 'Binary Arbitrage', desc: 'PolyMarket YES/NO arb'},
        {id: 'sniper', name: '15-Min Sniper', desc: 'Momentum sniper'},
        {id: 'contrarian', name: 'Contrarian', desc: 'Mean reversion'},
        {id: 'momentum', name: 'Momentum', desc: 'Trend following'},
        {id: 'pairs', name: 'Pairs Trading', desc: 'Statistical arb'},
        {id: 'high_risk', name: 'YOLO', desc: 'High risk gambles'}
    ];
    
    const container = document.getElementById('strategy-toggles');
    container.innerHTML = strategies.map(s => `
        <div class="col-md-4">
            <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                <div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggle-${s.id}" checked>
                        <label class="form-check-label" for="toggle-${s.id}">${s.name}</label>
                    </div>
                    <small class="text-muted">${s.desc}</small>
                </div>
            </div>
        </div>
    `).join('');
}

// Load Signals
async function loadSignals() {
    try {
        const resp = await fetch('/api/data');
        const data = await resp.json();
        
        const container = document.getElementById('signals-container');
        const prices = (data.prices || []).slice(0, 5);
        
        if (prices.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No signals available</div>';
            return;
        }
        
        container.innerHTML = '<div class="row g-2">' + prices.map(p => {
            const symbol = p.symbol.split('/')[0];
            const change = p.change_24h || 0;
            return `
                <div class="col-6">
                    <div class="card bg-dark">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <strong>${symbol}</strong>
                                <span class="badge ${change > 0 ? 'bg-success' : 'bg-danger'}">${change.toFixed(1)}%</span>
                            </div>
                            <div class="h5 mb-0">$${p.price.toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('') + '</div>';
    } catch (e) {
        document.getElementById('signals-container').innerHTML = '<div class="alert alert-warning">Error loading signals</div>';
    }
}

// Load Macro Events
async function loadMacroEvents() {
    try {
        const resp = await fetch('/api/macro/events?days=30');
        const data = await resp.json();
        
        if (data.success) {
            const status = document.getElementById('trading-allowed');
            if (data.data.should_pause) {
                status.textContent = 'PAUSED';
                status.className = 'badge bg-danger';
            } else {
                status.textContent = 'ALLOWED';
                status.className = 'badge bg-success';
            }
            
            const eventsDiv = document.getElementById('upcoming-events');
            if (data.data.upcoming_events.length > 0) {
                eventsDiv.innerHTML = data.data.upcoming_events.slice(0, 3).map(e => `
                    <div class="mb-2 p-2 bg-dark rounded">
                        <div class="d-flex justify-content-between">
                            <strong>${e.event}</strong>
                            <span class="badge bg-${e.impact === 'CRITICAL' ? 'danger' : e.impact === 'HIGH' ? 'warning text-dark' : 'info'}">${e.impact}</span>
                        </div>
                        <small class="text-muted">${e.date} (${e.days_until} days)</small>
                    </div>
                `).join('');
            } else {
                eventsDiv.innerHTML = '<div class="text-muted">No major events in next 30 days</div>';
            }
        }
    } catch (e) {
        console.error('Macro events load failed:', e);
    }
}

// Run Agent Evaluation
async function runAgentEvaluation() {
    if (!confirm('Run evaluation cycle? This will kill poor performers and scale winners.')) return;
    
    try {
        const resp = await fetch('/api/multi-agent/evaluate', {method: 'POST'});
        const data = await resp.json();
        
        if (data.success) {
            alert(`Evaluation complete! Killed: ${data.results.killed.length}, Scaled: ${data.results.scaled_up.length}`);
            loadAgentStatus();
        } else {
            alert('Evaluation failed: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Refresh functions
function refreshAgents() { loadAgentStatus(); }
function refreshML() { loadSignals(); }
function toggleAgentModal() {
    const modal = new bootstrap.Modal(document.getElementById('agentModal'));
    modal.show();
}
</script>
{% endblock %}

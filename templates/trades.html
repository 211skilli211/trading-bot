{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-0 px-lg-3">
    <h2 class="h4 mb-3">ðŸ“œ Trade History</h2>
    
    <div class="card">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
            <span>All Trades ({{ data.trades|length }})</span>
            <button onclick="exportTrades()" class="btn btn-sm btn-success">
                <i class="bi bi-download"></i> Export
            </button>
        </div>
        <div class="card-body p-0">
            {% if data.trades and data.trades|length > 0 %}
            <div class="table-wrapper">
                <table class="table table-dark table-hover mb-0" style="min-width: 600px;" id="tradesTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Exchange</th>
                            <th>Type</th>
                            <th class="text-end">P&L</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in data.trades %}
                        <tr>
                            <td class="small" style="white-space: nowrap;">
                                {% if trade.timestamp %}
                                    {{ trade.timestamp|truncate(16, true, '') }}
                                {% else %}
                                    --:--
                                {% endif %}
                            </td>
                            <td class="small">{{ trade.buy_exchange|default('N/A') }}</td>
                            <td>
                                <span class="badge {{ 'bg-danger' if trade.mode == 'LIVE' else 'bg-success' }}">
                                    {{ trade.mode|default('PAPER') }}
                                </span>
                            </td>
                            <td class="text-end {{ 'text-success' if trade.net_pnl|default(0) >= 0 else 'text-danger' }} fw-bold">
                                {{ "%.2f"|format(trade.net_pnl|default(0)) }}
                            </td>
                            <td>
                                <span class="badge {{ 'bg-success' if trade.status == 'FILLED' else 'bg-warning' }}">
                                    {{ trade.status|default('PENDING') }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="mt-3 text-muted">No trades yet</p>
                <small class="text-muted">Run the bot in paper mode to see trades here</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function exportTrades() {
    const table = document.getElementById('tradesTable');
    if (!table) return;
    let csv = 'Time,Exchange,Type,P&L,Status\n';
    table.querySelectorAll('tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
            const rowData = Array.from(cells).map(c => '"' + c.textContent.trim().replace(/"/g, '""') + '"');
            csv += rowData.join(',') + '\n';
        }
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'trades_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <h2 class="h4 mb-3">ðŸ“œ Trade History</h2>
    
    <div class="card">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
            <span>All Trades ({{ data.trades|length }})</span>
            <button onclick="exportTrades()" class="btn btn-sm btn-success">
                <i class="bi bi-download"></i> Export CSV
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0" id="tradesTable">
                    <thead>
                        <tr>
                            <th class="d-none d-md-table-cell">ID</th>
                            <th>Time</th>
                            <th class="d-none d-sm-table-cell">Mode</th>
                            <th class="d-none d-lg-table-cell">Buy</th>
                            <th class="d-none d-lg-table-cell">Sell</th>
                            <th>Qty</th>
                            <th>P&L</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if data.trades %}
                            {% for trade in data.trades %}
                            <tr>
                                <td class="d-none d-md-table-cell"><code class="small">{{ trade.trade_id|default("N/A") }}</code></td>
                                <td class="small">{{ trade.timestamp[11:16] if trade.timestamp else "--:--" }}</td>
                                <td class="d-none d-sm-table-cell">
                                    <span class="badge {% if trade.mode == "LIVE" %}bg-danger{% else %}bg-success{% endif %}">{{ trade.mode|default("PAPER") }}</span>
                                </td>
                                <td class="d-none d-lg-table-cell small">{{ trade.buy_exchange|default("N/A") }}</td>
                                <td class="d-none d-lg-table-cell small">{{ trade.sell_exchange|default("N/A") }}</td>
                                <td class="small">{{ "%.4f"|format(trade.quantity|default(0)) }}</td>
                                <td class="{% if trade.net_pnl and trade.net_pnl >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                    {{ "%.2f"|format(trade.net_pnl|default(0)) }}
                                </td>
                                <td>
                                    <span class="badge {% if trade.status == "FILLED" %}bg-success{% elif trade.status == "REJECTED" %}bg-danger{% else %}bg-warning{% endif %}">
                                        {{ trade.status|default("UNKNOWN")[:8] }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-5">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                    <p class="mt-2">No trades yet</p>
                                    <small>Keep running in paper mode to see trades here</small>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Stats -->
    {% if data.trades %}
    <div class="row g-2 mt-3">
        <div class="col-6 col-md-3">
            <div class="kpi-card text-center">
                <div class="small text-muted">TOTAL TRADES</div>
                <div class="h4 mb-0">{{ data.trades|length }}</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card text-center">
                <div class="small text-muted">WINNING</div>
                <div class="h4 mb-0 text-success">{{ data.trades|selectattr("net_pnl", ">", 0)|list|length }}</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card text-center">
                <div class="small text-muted">TOTAL P&L</div>
                <div class="h4 mb-0 {% if data.trades|sum(attribute="net_pnl") >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ "%.2f"|format(data.trades|sum(attribute="net_pnl")) }}
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card text-center">
                <div class="small text-muted">WIN RATE</div>
                <div class="h4 mb-0 text-info">
                    {% set wins = data.trades|selectattr("net_pnl", ">", 0)|list|length %}
                    {% set total = data.trades|length %}
                    {{ "%.1f"|format((wins/total*100) if total > 0 else 0) }}%
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

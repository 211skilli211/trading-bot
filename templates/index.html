{% extends "base.html" %}
{% set active = 'overview' %}
{% block content %}
<!-- KPI Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="text-muted small">TOTAL P&L</div>
            <div class="kpi-value {% if kpis.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                {{ "%.2f"|format(kpis.pnl|default(0)) }} USDT
            </div>
            <small class="text-muted">{{ total_trades|default(0) }} trades</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="text-muted small">WIN RATE</div>
            <div class="kpi-value text-info">{{ "%.1f"|format(kpis.winrate|default(0)) }}%</div>
            <small class="text-muted">{{ winning_trades|default(0) }} / {{ total_trades|default(0) }}</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="text-muted small">MAX DRAWDOWN</div>
            <div class="kpi-value text-warning">{{ "%.2f"|format(kpis.drawdown|default(0)) }}%</div>
            <small class="text-muted">Risk metric</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card">
            <div class="text-muted small">EXPOSURE</div>
            <div class="kpi-value">{{ "%.2f"|format(kpis.exposure|default(0)) }} USDT</div>
            <small class="text-muted">Open positions</small>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Equity Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Equity Curve</h5>
                <span class="badge bg-secondary">7 Days</span>
            </div>
            <div class="card-body">
                <canvas id="equityChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Trades -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Trades</h5>
                <button onclick="exportTrades()" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-download"></i> CSV
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>P&L</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in recent_trades[:6] %}
                            <tr>
                                <td class="small">{{ trade.timestamp[11:16] if trade.timestamp else '--:--' }}</td>
                                <td class="{% if trade.net_pnl and trade.net_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.2f"|format(trade.net_pnl or 0) }}
                                </td>
                                <td>
                                    <span class="badge {% if trade.status == 'FILLED' %}bg-success{% elif trade.status == 'REJECTED' %}bg-danger{% else %}bg-warning{% endif %}">
                                        {{ trade.status[:8] }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                    <p class="mt-2">No trades yet</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Prices Preview -->
<div class="row g-3 mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-currency-exchange"></i> Live Prices</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Exchange</th>
                                <th>Bid</th>
                                <th>Ask</th>
                                <th>Spread</th>
                                <th>24h Volume</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in prices %}
                            <tr>
                                <td><strong>{{ price.exchange }}</strong></td>
                                <td>${{ "%.2f"|format(price.bid|default(price.price)) }}</td>
                                <td>${{ "%.2f"|format(price.ask|default(price.price)) }}</td>
                                <td>
                                    {% set spread = ((price.ask|default(price.price) - price.bid|default(price.price)) / price.price * 100) %}
                                    <span class="{% if spread > 0.5 %}text-success{% else %}text-muted{% endif %}">
                                        {{ "%.4f"|format(spread) }}%
                                    </span>
                                </td>
                                <td class="text-muted">{{ "%.2f"|format(price.volume_24h|default(0)) }} BTC</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <a href="/prices" class="btn btn-outline-light btn-sm">View All Prices <i class="bi bi-arrow-right"></i></a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const ctx = document.getElementById('equityChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_labels|default(['Mon','Tue','Wed','Thu','Fri','Sat','Sun'])|tojson }},
        datasets: [{
            label: 'Balance',
            data: {{ chart_data|default([10000,10012,10008,10025,10045,10038,10052])|tojson }},
            borderColor: '#39d353',
            backgroundColor: 'rgba(57,211,83,0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { grid: { color: '#2d3a4a' } },
            x: { grid: { display: false } }
        }
    }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="row g-3 mb-4">
  <!-- KPI Cards -->
  <div class="col-md-3">
    <div class="kpi-card">
      <div class="kpi-label">Total P&L</div>
      <div class="kpi-value {% if data.total_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
        {{ "%.2f"|format(data.total_pnl) }} USDT
      </div>
      <small class="text-muted">{{ data.total_trades }} trades</small>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="kpi-card">
      <div class="kpi-label">Win Rate</div>
      <div class="kpi-value text-info">{{ "%.1f"|format(data.win_rate) }}%</div>
      <small class="text-muted">{{ data.winning_trades }} / {{ data.total_trades }}</small>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="kpi-card">
      <div class="kpi-label">Max Drawdown</div>
      <div class="kpi-value text-warning">{{ "%.2f"|format(data.max_drawdown) }}%</div>
      <small class="text-muted">Risk metric</small>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="kpi-card">
      <div class="kpi-label">Exposure</div>
      <div class="kpi-value">{{ "%.2f"|format(data.exposure) }} USDT</div>
      <small class="text-muted">Open positions</small>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Chart -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Equity Curve</h5>
        <span class="badge bg-secondary">Last 7 Days</span>
      </div>
      <div class="card-body">
        <canvas id="equityChart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Recent Trades -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Trades</h5>
        <button class="btn btn-sm btn-outline-light" onclick="exportTrades()">
          <i class="bi bi-download"></i> CSV
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover mb-0" id="tradesTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>P&L</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for trade in data.recent_trades[:5] %}
              <tr>
                <td>{{ trade.timestamp[:19] if trade.timestamp else 'N/A' }}</td>
                <td class="{% if trade.net_pnl and trade.net_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {{ "%.2f"|format(trade.net_pnl or 0) }}
                </td>
                <td>
                  <span class="badge {% if trade.status == 'FILLED' %}bg-success{% elif trade.status == 'REJECTED' %}bg-danger{% else %}bg-warning{% endif %}">
                    {{ trade.status }}
                  </span>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="text-center text-muted py-4">No trades yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-3">
  <!-- Live Prices -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-currency-exchange"></i> Live Prices</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>Exchange</th>
                <th>Price</th>
                <th>Spread</th>
              </tr>
            </thead>
            <tbody>
              {% for price in data.prices %}
              <tr>
                <td>{{ price.exchange }}</td>
                <td>${{ "%.2f"|format(price.price) }}</td>
                <td>
                  {% if loop.first %}
                  <span class="badge bg-success">Best</span>
                  {% else %}
                  <span class="text-muted">{{ "%.4f"|format((price.price - data.prices[0].price) / data.prices[0].price * 100) }}%</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Open Positions -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-wallet2"></i> Open Positions</h5>
      </div>
      <div class="card-body">
        {% if data.positions %}
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Entry</th>
                <th>P&L</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for pos in data.positions %}
              <tr>
                <td>{{ pos.position_id }}</td>
                <td>${{ "%.2f"|format(pos.entry_price) }}</td>
                <td class="{% if pos.unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {{ "%.2f"|format(pos.unrealized_pnl) }}
                </td>
                <td>
                  <button class="btn btn-sm btn-danger" onclick="closePosition('{{ pos.position_id }}')">
                    Close
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
          <i class="bi bi-check-circle" style="font-size: 3rem;"></i>
          <p class="mt-2">No open positions</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Equity Chart
const ctx = document.getElementById('equityChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: {{ data.chart_labels | tojson }},
    datasets: [{
      label: 'Balance',
      data: {{ data.chart_data | tojson }},
      borderColor: '#58a6ff',
      backgroundColor: 'rgba(88, 166, 255, 0.1)',
      fill: true,
      tension: 0.4
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false }
    },
    scales: {
      y: {
        beginAtZero: false,
        grid: { color: '#30363d' }
      },
      x: {
        grid: { display: false }
      }
    }
  }
});
</script>
{% endblock %}

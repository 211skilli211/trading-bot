{% extends "base.html" %}
{% block content %}
<div class="container-fluid px-0 px-lg-3">
    <!-- KPI Cards - Stacked on mobile, 4 columns on desktop -->
    <div class="row g-2 mb-3">
        <div class="col-6 col-lg-3">
            <div class="kpi-card">
                <div class="small text-muted">P&L</div>
                <div class="kpi-value {{ 'text-success' if data.trades|sum(attribute='net_pnl') >= 0 else 'text-danger' }}">
                    {{ "%.2f"|format(data.trades|sum(attribute='net_pnl')) }}
                </div>
                <small class="text-muted">Total Profit/Loss</small>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="kpi-card">
                <div class="small text-muted">TRADES</div>
                <div class="kpi-value">{{ data.trades|length }}</div>
                <small class="text-muted">Total Executed</small>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="kpi-card">
                <div class="small text-muted">POSITIONS</div>
                <div class="kpi-value">{{ data.positions|length }}</div>
                <small class="text-muted">Currently Open</small>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="kpi-card">
                <div class="small text-muted">MODE</div>
                <div class="kpi-value {{ 'text-danger' if data.mode == 'LIVE' else 'text-success' }}">{{ data.mode }}</div>
                <small class="text-muted">{{ 'Real Money' if data.mode == 'LIVE' else 'Simulation' }}</small>
            </div>
        </div>
    </div>

    <!-- Health Status -->
    <div class="card mb-3" id="health-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-heart-pulse"></i> System Health</span>
            <span id="health-status-badge" class="badge bg-secondary">Checking...</span>
        </div>
        <div class="card-body">
            <div class="row g-2 text-center" id="health-indicators">
                <div class="col-6 col-md-3">
                    <div class="p-2 rounded bg-dark">
                        <i class="bi bi-hdd-network text-muted"></i>
                        <div class="small text-muted">Exchanges</div>
                        <div class="fw-bold" id="health-exchanges">-</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="p-2 rounded bg-dark">
                        <i class="bi bi-database text-muted"></i>
                        <div class="small text-muted">Database</div>
                        <div class="fw-bold" id="health-database">-</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="p-2 rounded bg-dark">
                        <i class="bi bi-memory text-muted"></i>
                        <div class="small text-muted">Memory</div>
                        <div class="fw-bold" id="health-memory">-</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="p-2 rounded bg-dark">
                        <i class="bi bi-hdd text-muted"></i>
                        <div class="small text-muted">Disk</div>
                        <div class="fw-bold" id="health-disk">-</div>
                    </div>
                </div>
            </div>
            <div class="mt-2 text-end">
                <small class="text-muted">Last check: <span id="health-timestamp">-</span></small>
                <button class="btn btn-sm btn-outline-light ms-2" onclick="refreshHealth()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-3">
        <div class="card-header">
            <i class="bi bi-lightning"></i> Quick Actions
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-6 col-md-3">
                    <a href="/config" class="btn btn-outline-light w-100">
                        <i class="bi bi-sliders"></i> Config
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="/analytics" class="btn btn-outline-light w-100">
                        <i class="bi bi-bar-chart"></i> Analytics
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-light w-100" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="col-6 col-md-3">
                    <button class="btn btn-outline-danger w-100" onclick="stopBot()">
                        <i class="bi bi-stop-circle"></i> Stop Bot
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Price Cards -->
    <div class="d-lg-none mb-3">
        <h6 class="mb-2">Live Crypto Prices</h6>
        {% for price in data.prices[:8] %}
        {% set symbol_base = price.symbol.split('/')[0] %}
        <div class="card mb-2">
            <div class="card-body d-flex justify-content-between align-items-center py-2">
                <div class="d-flex align-items-center">
                    <img src="https://assets.coingecko.com/coins/images/1/small/{{ symbol_base.lower() }}.png" 
                         onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name={{ symbol_base }}&background=random&color=fff&size=32&font-size=0.5&bold=true';"
                         class="me-2 coin-icon" 
                         data-symbol="{{ symbol_base }}"
                         style="width: 32px; height: 32px; border-radius: 50%; background: #1a1a2e;">
                    <div>
                        <strong>{{ symbol_base }}</strong>
                        <small class="text-muted d-block">{{ price.exchange }}</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="h5 mb-0">${{ "%.2f"|format(price.price) }}</div>
                    {% if price.change_24h|default(0) != 0 %}
                    <small class="{{ 'text-success' if price.change_24h > 0 else 'text-danger' }}">
                        {{ "%.1f"|format(price.change_24h) }}%
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Desktop Tables -->
    <div class="row g-3">
        <!-- Live Prices -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-graph-up"></i> Live Prices</span>
                    <a href="/prices" class="btn btn-sm btn-outline-light">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-wrapper d-none d-lg-block">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr><th>Coin</th><th>Exchange</th><th>Price</th><th>24h</th></tr>
                            </thead>
                            <tbody>
                                {% for price in data.prices[:10] %}
                                {% set symbol_base = price.symbol.split('/')[0] %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="https://assets.coingecko.com/coins/images/1/small/{{ symbol_base.lower() }}.png" 
                                                 onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name={{ symbol_base }}&background=random&color=fff&size=24&font-size=0.5&bold=true';"
                                                 class="me-2 coin-icon" 
                                                 data-symbol="{{ symbol_base }}"
                                                 style="width: 24px; height: 24px; border-radius: 50%; background: #1a1a2e;">
                                            <strong>{{ symbol_base }}</strong>
                                        </div>
                                    </td>
                                    <td>{{ price.exchange }}</td>
                                    <td class="h5">${{ "%.2f"|format(price.price) }}</td>
                                    <td>
                                        {% if price.change_24h|default(0) > 0 %}
                                        <span class="text-success">+{{ "%.1f"|format(price.change_24h) }}%</span>
                                        {% elif price.change_24h|default(0) < 0 %}
                                        <span class="text-danger">{{ "%.1f"|format(price.change_24h) }}%</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-lg-none p-3">
                        {% for price in data.prices[:5] %}
                        {% set symbol_base = price.symbol.split('/')[0] %}
                        <div class="d-flex justify-content-between py-2 border-bottom border-secondary">
                            <span><strong>{{ symbol_base }}</strong> <small class="text-muted">{{ price.exchange }}</small></span>
                            <strong>${{ "%.2f"|format(price.price) }}</strong>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-ul"></i> Recent Trades</span>
                    <a href="/trades" class="btn btn-sm btn-outline-light">View All</a>
                </div>
                <div class="card-body p-0">
                    {% if data.trades and data.trades|length > 0 %}
                    <div class="table-wrapper">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr><th>Time</th><th>Type</th><th class="text-end">P&L</th></tr>
                            </thead>
                            <tbody>
                                {% for trade in data.trades[:5] %}
                                <tr>
                                    <td class="small">{{ trade.timestamp|truncate(16, true, '') if trade.timestamp else '--:--' }}</td>
                                    <td>
                                        <span class="badge {{ 'bg-danger' if trade.mode == 'LIVE' else 'bg-success' }}">
                                            {{ trade.mode|default('PAPER') }}
                                        </span>
                                    </td>
                                    <td class="text-end {{ 'text-success' if trade.net_pnl|default(0) >= 0 else 'text-danger' }}">
                                        {{ "%.2f"|format(trade.net_pnl|default(0)) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                        <p class="mt-2 text-muted mb-0">No trades yet</p>
                        <small class="text-muted">Run the bot to start trading</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Open Positions -->
    {% if data.positions and data.positions|length > 0 %}
    <div class="card mt-3">
        <div class="card-header">
            <i class="bi bi-wallet2"></i> Open Positions ({{ data.positions|length }})
        </div>
        <div class="card-body p-0">
            <div class="table-wrapper">
                <table class="table table-dark table-hover mb-0">
                    <thead>
                        <tr><th>ID</th><th>Exchange</th><th>Entry Price</th><th>P&L</th></tr>
                    </thead>
                    <tbody>
                        {% for pos in data.positions %}
                        <tr>
                            <td>{{ pos.position_id|default('N/A') }}</td>
                            <td>{{ pos.exchange|default('N/A') }}</td>
                            <td>${{ "%.2f"|format(pos.entry_price|default(0)) }}</td>
                            <td class="{{ 'text-success' if pos.unrealized_pnl|default(0) >= 0 else 'text-danger' }}">
                                {{ "%.2f"|format(pos.unrealized_pnl|default(0)) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Info Alert -->
    <div class="alert alert-info mt-3">
        <i class="bi bi-info-circle"></i> 
        Running in <strong>{{ data.mode }}</strong> mode. 
        {{ 'Real money at risk!' if data.mode == 'LIVE' else 'No real money at risk.' }}
        <span class="d-none d-md-inline">| <i class="bi bi-clock"></i> Auto-refresh: 30s</span>
    </div>
</div>

<script>
function refreshData() {
    document.getElementById('loading').style.display = 'flex';
    location.reload();
}

function stopBot() {
    if (confirm('Are you sure you want to stop the trading bot?')) {
        document.getElementById('loading').style.display = 'flex';
        fetch('/api/stop', {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                alert(data.message || 'Bot stopped');
                location.reload();
            })
            .catch(e => {
                alert('Error: ' + e);
                document.getElementById('loading').style.display = 'none';
            });
    }
}

// Update stats periodically without full reload
setInterval(() => {
    fetch('/api/stats')
        .then(r => r.json())
        .then(stats => {
            // Could update specific DOM elements here
            console.log('Stats updated:', stats);
        })
        .catch(console.error);
}, 30000);

// Health status functions
function updateHealthDisplay(data) {
    const badge = document.getElementById('health-status-badge');
    const card = document.getElementById('health-card');
    
    // Update badge
    badge.textContent = data.status.toUpperCase();
    badge.className = 'badge ' + 
        (data.status === 'healthy' ? 'bg-success' : 
         data.status === 'degraded' ? 'bg-warning' : 'bg-danger');
    
    // Update card border
    card.style.borderColor = 
        data.status === 'healthy' ? 'var(--success)' : 
        data.status === 'degraded' ? 'var(--warning)' : 'var(--danger)';
    
    // Update indicators
    if (data.indicators) {
        document.getElementById('health-exchanges').textContent = data.indicators.exchanges || '-';
        document.getElementById('health-database').textContent = (data.indicators.database || '-').toUpperCase();
        document.getElementById('health-memory').textContent = data.indicators.memory || '-';
        document.getElementById('health-disk').textContent = data.indicators.disk || '-';
        
        // Color code the indicators
        const dbEl = document.getElementById('health-database');
        if (data.indicators.database === 'healthy') dbEl.className = 'fw-bold text-success';
        else if (data.indicators.database === 'unhealthy') dbEl.className = 'fw-bold text-danger';
        else dbEl.className = 'fw-bold text-warning';
    }
    
    // Update timestamp
    const ts = new Date(data.timestamp);
    document.getElementById('health-timestamp').textContent = ts.toLocaleTimeString();
}

function refreshHealth() {
    fetch('/api/health')
        .then(r => r.json())
        .then(data => {
            updateHealthDisplay(data);
        })
        .catch(err => {
            console.error('Health check failed:', err);
            document.getElementById('health-status-badge').textContent = 'ERROR';
            document.getElementById('health-status-badge').className = 'badge bg-danger';
        });
}

// Initial health check on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshHealth();
    // Refresh health every 60 seconds
    setInterval(refreshHealth, 60000);
});
</script>
{% endblock %}

{% extends "base.html" %}
{% set active = 'positions' %}
{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-wallet2"></i> Open Positions</h5>
        <span class="badge bg-info">{{ positions|length }} Open</span>
    </div>
    <div class="card-body">
        {% if positions %}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Position ID</th>
                        <th>Exchange</th>
                        <th>Side</th>
                        <th>Entry Price</th>
                        <th>Size</th>
                        <th>Stop Loss</th>
                        <th>Take Profit</th>
                        <th>P&L</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pos in positions %}
                    <tr>
                        <td><code>{{ pos.position_id }}</code></td>
                        <td>{{ pos.exchange }}</td>
                        <td>
                            <span class="badge {% if pos.side == 'LONG' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ pos.side }}
                            </span>
                        </td>
                        <td>${{ "%.2f"|format(pos.entry_price) }}</td>
                        <td>{{ "%.4f"|format(pos.quantity) }} BTC</td>
                        <td class="text-danger">${{ "%.2f"|format(pos.stop_loss_price|default(0)) }}</td>
                        <td class="text-success">${{ "%.2f"|format(pos.take_profit_price|default(0)) }}</td>
                        <td class="{% if pos.unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                            {{ "%.2f"|format(pos.unrealized_pnl|default(0)) }}
                        </td>
                        <td>
                            <button onclick="closePosition('{{ pos.position_id }}')" class="btn btn-sm btn-danger">
                                <i class="bi bi-x-lg"></i> Close
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="row g-3 mt-3">
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <div class="text-muted small">TOTAL EXPOSURE</div>
                        <h4 class="text-warning">{{ "%.2f"|format(exposure|default(0)) }} USDT</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <div class="text-muted small">UNREALIZED P&L</div>
                        <h4 class="{% if unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(unrealized_pnl|default(0)) }} USDT
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <div class="text-muted small">MARGIN USED</div>
                        <h4>{{ "%.2f"|format(margin_used|default(0)) }}%</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark border-secondary">
                    <div class="card-body text-center">
                        <div class="text-muted small">AVAILABLE</div>
                        <h4 class="text-info">{{ "%.2f"|format(available|default(balance)) }} USDT</h4>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
            <h4 class="mt-3">No Open Positions</h4>
            <p class="text-muted">Your portfolio is currently flat. The bot will open positions when opportunities arise.</p>
            <a href="/config" class="btn btn-outline-light mt-2">
                <i class="bi bi-sliders"></i> Adjust Strategy
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Position History -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Closed Positions (Last 10)</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Closed</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Realized P&L</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pos in closed_positions[:10] %}
                    <tr>
                        <td><code>{{ pos.position_id }}</code></td>
                        <td class="small">{{ pos.close_timestamp[11:16] if pos.close_timestamp else 'N/A' }}</td>
                        <td>${{ "%.2f"|format(pos.entry_price) }}</td>
                        <td>${{ "%.2f"|format(pos.close_price|default(0)) }}</td>
                        <td class="{% if pos.unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(pos.unrealized_pnl|default(0)) }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">No closed positions yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
